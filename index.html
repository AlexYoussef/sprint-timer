<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üê±‚ö° Sprint Timer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    color: #e0e0e0;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    overflow: hidden;
  }
  .container {
    text-align: center;
    max-width: 600px;
    padding: 2rem;
  }
  .header {
    font-size: 1.2rem;
    color: #666;
    margin-bottom: 0.5rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .task {
    font-size: 1rem;
    color: #888;
    margin-bottom: 2rem;
    font-style: italic;
  }
  .clock {
    font-size: 8rem;
    font-weight: 200;
    letter-spacing: 0.05em;
    margin: 1rem 0;
    transition: color 0.5s;
  }
  .clock.warning { color: #f59e0b; }
  .clock.danger { color: #ef4444; animation: pulse 1s infinite; }
  .clock.done { color: #22c55e; }
  .clock.running { color: #e0e0e0; }
  .clock.waiting { color: #333; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .progress-bar {
    width: 100%;
    height: 4px;
    background: #1a1a1a;
    border-radius: 2px;
    margin: 2rem 0;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
    border-radius: 2px;
    transition: width 1s linear;
  }
  .status {
    font-size: 1rem;
    color: #555;
    margin-top: 1rem;
  }
  .sprint-label {
    display: inline-block;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 0.3rem 0.8rem;
    font-size: 0.8rem;
    color: #888;
    margin-bottom: 1rem;
  }
  .controls {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  button {
    background: #1a1a1a;
    color: #e0e0e0;
    border: 1px solid #333;
    padding: 0.6rem 1.5rem;
    font-family: inherit;
    font-size: 0.9rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }
  button:hover { background: #2a2a2a; border-color: #555; }
  button.primary { border-color: #22c55e; color: #22c55e; }
  button.primary:hover { background: #22c55e22; }
  button.danger { border-color: #ef4444; color: #ef4444; }
  button.danger:hover { background: #ef444422; }
  .setup {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }
  .setup h1 { font-size: 2rem; font-weight: 300; margin-bottom: 1rem; }
  .time-presets { display: flex; gap: 0.8rem; flex-wrap: wrap; justify-content: center; }
  .time-presets button { font-size: 1.1rem; padding: 0.8rem 1.5rem; }
  input[type="text"] {
    background: #1a1a1a;
    border: 1px solid #333;
    color: #e0e0e0;
    padding: 0.6rem 1rem;
    font-family: inherit;
    font-size: 1rem;
    border-radius: 4px;
    width: 300px;
    text-align: center;
  }
  input[type="text"]::placeholder { color: #444; }
  .checkins {
    margin-top: 1.5rem;
    font-size: 0.85rem;
    color: #555;
  }
  .checkins span.hit { color: #22c55e; text-decoration: line-through; }
  .checkins span.next { color: #f59e0b; }
  .sync-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.5rem;
    vertical-align: middle;
  }
  .sync-dot.connected { background: #22c55e; }
  .sync-dot.disconnected { background: #ef4444; }
  .sync-dot.polling { background: #f59e0b; animation: pulse 1s infinite; }
  .sync-status {
    position: fixed;
    top: 1rem;
    right: 1rem;
    font-size: 0.7rem;
    color: #444;
  }
  .no-youtube {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    font-size: 0.75rem;
    color: #333;
    letter-spacing: 0.1em;
  }
  .waiting-screen {
    text-align: center;
  }
  .waiting-screen h1 {
    font-size: 2rem;
    font-weight: 300;
    margin-bottom: 1rem;
  }
  .waiting-screen p {
    color: #555;
    font-size: 0.9rem;
  }
  .waiting-pulse {
    font-size: 4rem;
    color: #333;
    animation: pulse 2s infinite;
    margin: 2rem 0;
  }
</style>
</head>
<body>

<div class="sync-status">
  <span class="sync-dot polling" id="sync-dot"></span>
  <span id="sync-text">connecting...</span>
</div>

<div class="container" id="setup-screen">
  <div class="setup">
    <h1>üê±‚ö° Sprint Timer</h1>
    <input type="text" id="task-input" placeholder="What are you working on?">
    <div class="time-presets">
      <button onclick="startTimer(15)">15 min</button>
      <button onclick="startTimer(25)">25 min</button>
      <button onclick="startTimer(50)" class="primary">50 min</button>
      <button onclick="startTimer(75)">75 min</button>
      <button onclick="startTimer(90)">90 min</button>
    </div>
    <p style="color:#555; font-size:0.8rem; margin-top:1rem;">or wait for Ford to start a session ‚Üë</p>
  </div>
</div>

<div class="container" id="waiting-screen" style="display:none;">
  <div class="waiting-screen">
    <h1>üê±‚ö° Sprint Timer</h1>
    <div class="waiting-pulse">‚è≥</div>
    <p>Waiting for Ford to start a session...</p>
    <p style="margin-top:0.5rem; color:#444; font-size:0.8rem;">Polling every 5 seconds</p>
    <div class="controls" style="margin-top:2rem;">
      <button onclick="showSetup()">Start manually instead</button>
    </div>
  </div>
</div>

<div class="container" id="timer-screen" style="display:none;">
  <div class="sprint-label" id="sprint-label">SPRINT</div>
  <div class="header">BODY DOUBLING</div>
  <div class="task" id="task-display"></div>
  <div class="clock running" id="clock">50:00</div>
  <div class="progress-bar"><div class="progress-fill" id="progress" style="width:0%"></div></div>
  <div class="checkins" id="checkins"></div>
  <div class="status" id="status">focused.</div>
  <div class="controls">
    <button onclick="pauseResume()" id="pause-btn">‚è∏ Pause</button>
    <button onclick="resetTimer()" class="danger">‚úï End</button>
  </div>
</div>

<div class="no-youtube">no youtube.</div>

<script>
// Config
const API_URL = 'https://yellow-block-6533.alexeyyoussef.workers.dev';
const API_KEY = new URLSearchParams(window.location.search).get('key') || '';
const POLL_INTERVAL = 5000;

let totalSeconds = 0;
let startedAtMs = 0;
let localInterval = null;
let paused = false;
let checkinTimes = [];
let syncMode = !!API_KEY; // true if key provided
let currentMode = 'setup'; // setup | waiting | timer

function getCheckins(minutes) {
  if (minutes <= 15) return [10];
  if (minutes <= 25) return [15];
  if (minutes <= 50) return [15, 35];
  if (minutes <= 75) return [20, 45, 60];
  return Array.from({length: Math.floor(minutes/20)}, (_, i) => (i+1)*20).filter(t => t < minutes);
}

function formatTime(s) {
  if (s < 0) s = 0;
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function showScreen(name) {
  document.getElementById('setup-screen').style.display = name === 'setup' ? 'block' : 'none';
  document.getElementById('waiting-screen').style.display = name === 'waiting' ? 'block' : 'none';
  document.getElementById('timer-screen').style.display = name === 'timer' ? 'block' : 'none';
  currentMode = name;
}

function showSetup() { showScreen('setup'); }

function startTimer(minutes, task, startMs, sprint) {
  totalSeconds = minutes * 60;
  startedAtMs = startMs || Date.now();
  checkinTimes = getCheckins(minutes);
  
  const taskText = task || document.getElementById('task-input').value || 'Deep work';
  document.getElementById('task-display').textContent = taskText;
  document.getElementById('sprint-label').textContent = sprint ? `SPRINT ${sprint} ¬∑ ${minutes} MIN` : `${minutes} MIN SPRINT`;
  
  showScreen('timer');
  paused = false;
  
  if (localInterval) clearInterval(localInterval);
  localInterval = setInterval(tick, 1000);
  tick(); // immediate update
}

function tick() {
  if (paused) return;
  
  const elapsedMs = Date.now() - startedAtMs;
  const elapsedSeconds = Math.floor(elapsedMs / 1000);
  const remainingSeconds = Math.max(0, totalSeconds - elapsedSeconds);
  
  updateDisplay(remainingSeconds, elapsedSeconds);
  
  if (remainingSeconds <= 0) {
    clearInterval(localInterval);
    document.getElementById('status').textContent = '‚úÖ SESSION COMPLETE. Autopsy time.';
    document.getElementById('clock').className = 'clock done';
    document.title = '‚úÖ DONE';
  }
}

function updateDisplay(remainingSeconds, elapsedSeconds) {
  const elapsedMin = elapsedSeconds / 60;
  const pct = Math.min(100, (elapsedSeconds / totalSeconds) * 100);
  
  document.getElementById('clock').textContent = formatTime(remainingSeconds);
  document.getElementById('progress').style.width = pct + '%';
  document.title = `${formatTime(remainingSeconds)} ‚Äî Sprint`;
  
  // Color states
  const clock = document.getElementById('clock');
  if (remainingSeconds <= 0) {
    clock.className = 'clock done';
  } else if (remainingSeconds <= 60) {
    clock.className = 'clock danger';
  } else if (remainingSeconds <= 300) {
    clock.className = 'clock warning';
  } else {
    clock.className = 'clock running';
  }
  
  // Check-in display
  const checkinHtml = checkinTimes.map(t => {
    if (elapsedMin >= t) return `<span class="hit">‚úì ${t}min</span>`;
    const isNext = checkinTimes.filter(c => elapsedMin < c)[0] === t;
    if (isNext) return `<span class="next">‚Üí ${t}min check-in</span>`;
    return `<span>${t}min</span>`;
  }).join(' &nbsp;¬∑&nbsp; ');
  document.getElementById('checkins').innerHTML = checkinHtml;
  
  // Status text
  const statusEl = document.getElementById('status');
  if (remainingSeconds <= 0) statusEl.textContent = '‚úÖ session complete.';
  else if (remainingSeconds <= 60) statusEl.textContent = 'final minute. finish strong.';
  else if (remainingSeconds <= 300) statusEl.textContent = 'last 5 minutes. push.';
  else statusEl.textContent = 'focused.';
}

function pauseResume() {
  paused = !paused;
  document.getElementById('pause-btn').textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
  document.getElementById('status').textContent = paused ? '‚è∏ paused.' : 'focused.';
}

function resetTimer() {
  clearInterval(localInterval);
  if (syncMode) {
    showScreen('waiting');
  } else {
    showScreen('setup');
  }
  document.title = 'üê±‚ö° Sprint Timer';
}

// === SYNC MODE ===
let pollTimer = null;

async function pollState() {
  if (!syncMode) return;
  
  try {
    const dot = document.getElementById('sync-dot');
    const text = document.getElementById('sync-text');
    
    const res = await fetch(`${API_URL}/state?key=${API_KEY}`);
    if (!res.ok) {
      dot.className = 'sync-dot disconnected';
      text.textContent = 'auth failed';
      return;
    }
    
    const state = await res.json();
    dot.className = 'sync-dot connected';
    text.textContent = 'synced';
    
    if (state.active && currentMode !== 'timer') {
      // New sprint started ‚Äî auto-launch timer
      startTimer(state.durationMin, state.task, state.startedAt, state.sprint);
    } else if (!state.active && currentMode === 'timer') {
      // Sprint ended remotely
      clearInterval(localInterval);
      document.getElementById('status').textContent = '‚úÖ SESSION ENDED BY FORD.';
      document.getElementById('clock').className = 'clock done';
      document.title = '‚úÖ DONE';
      setTimeout(() => showScreen('waiting'), 5000);
    } else if (!state.active && currentMode === 'setup') {
      showScreen('waiting');
    }
  } catch (e) {
    document.getElementById('sync-dot').className = 'sync-dot disconnected';
    document.getElementById('sync-text').textContent = 'offline';
  }
}

// Init
const params = new URLSearchParams(window.location.search);

if (syncMode) {
  // Sync mode: poll backend
  showScreen('waiting');
  pollState();
  pollTimer = setInterval(pollState, POLL_INTERVAL);
} else if (params.get('min')) {
  // URL param mode: auto-start
  const startMs = params.get('start') ? parseInt(params.get('start')) : Date.now();
  startTimer(parseInt(params.get('min')), params.get('task') || '', startMs);
} else {
  // Manual mode
  showScreen('setup');
  document.getElementById('sync-dot').className = 'sync-dot disconnected';
  document.getElementById('sync-text').textContent = 'no key ‚Äî manual mode';
}
</script>
</body>
</html>
